# Cursor Rules: IPSec Network Diagnostics Tools

## Project Overview

This is a **bash-only** diagnostic toolkit for troubleshooting IPSec (ESP) packet issues on OpenShift clusters. All scripts run privileged commands on cluster nodes via `oc debug`.

## Core Principles

### KISS (Keep It Simple, Stupid)
- Prefer simple, readable solutions over clever optimizations
- One function should do one thing well
- Use standard tools (`tcpdump`, `ip xfrm`, `podman`) over custom implementations

### Relevant 12-Factor Principles
- **Config**: Store config in environment variables or `.env` files (never hardcode secrets)
- **Logs**: Output to stdout/stderr for easy redirection
- **Disposability**: Scripts should handle interrupts gracefully (trap handlers)
- **Admin Processes**: Each script is a one-off diagnostic task

## Security Rules

### Input Validation
- Always validate node names before `oc debug` commands
- Validate environment variables and CLI arguments before use
- Never trust user input for paths or command construction
- Use whitelist validation where possible

### Secure Bash Practices
- Use `set -euo pipefail` in all scripts
- Always quote variables: `"$VAR"` not `$VAR`
- Use `readonly` for constants
- Use arrays for command arguments: `cmd "${args[@]}"`
- Use `[[ ]]` for conditionals, not `[ ]`
- Use `local` for function variables
- Escape shell arguments properly when building commands for remote execution

### Credential & Secret Handling
- Never hardcode cluster credentials or tokens
- Rely on existing `oc` session (user must be logged in)
- Never log kubeconfig paths or tokens

### File Operations
- Use timestamp-based naming: `${TIMESTAMP}` or `$(date +%Y%m%d-%H%M%S)`
- Create output directories with `mkdir -p`
- Clean up remote temp files after retrieval
- Use `mktemp` for temporary files when needed

### Error Handling
- Check `oc` connectivity before operations: `oc whoami &>/dev/null`
- Use `|| true` for cleanup commands that may fail
- Provide helpful error messages with troubleshooting hints
- Exit with appropriate codes (0 = success, non-zero = failure)

## Project-Specific Rules

### Script Structure
All scripts must follow this pattern:

```bash
#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source config if available
if [[ -f "$SCRIPT_DIR/capture-config.env" ]]; then
    source "$SCRIPT_DIR/capture-config.env"
fi

# Define defaults with fallbacks
NODE1_NAME="${NODE1_NAME:-worker1.example.com}"

# Validate cluster connection
if ! oc whoami &>/dev/null; then
    echo "Error: Not connected to OpenShift cluster" >&2
    exit 1
fi
```

### OpenShift Node Commands
- Always use `oc debug node/` with `--to-namespace=default`
- Use `chroot /host` to access host filesystem
- Use `toolbox` for running tcpdump on RHCOS nodes
- Filter out oc debug noise: `grep -v "^Starting pod" | grep -v "^Removing debug"`
- Set explicit timeouts on long-running commands

```bash
# Good: Validated, filtered, with timeout
oc debug node/"$NODE_NAME" --to-namespace=default -- chroot /host bash -c "
    timeout ${DURATION} tcpdump -nn -s0 -i ${INTERFACE} -w /tmp/capture.pcap
" 2>&1 | grep -v "^Starting pod" | grep -v "^Removing debug"
```

### File Transfer from Nodes
- Use base64 encoding for retrieving binary files (pcap)
- Always check if file exists before transfer
- Validate retrieved data before writing

### IPSec/XFRM Diagnostics
- Capture XFRM state/policy at START and END of diagnostics
- Use `ip xfrm state show` and `ip xfrm policy show`
- Include XFRM counts for quick comparison
- Track ESP packets with tcpdump filter: `host {IP1} and host {IP2} and esp`

### Retis Integration
- Run Retis with `--privileged` for kernel tracing
- Use `-p xfrm_audit_state_icvfail/stack` for ICV failure tracking
- Mount required paths: `/sys`, `/proc`
- Use `--allow-system-changes` for probe installation

### Container Tools
- Always use Podman, never Docker
- Use Containerfile (not Dockerfile) if adding containers
- Build with `podman build` or `buildah bud`

### Configuration Variables
Required variables should have safe defaults:
```bash
INTERFACE="${INTERFACE:-br-ex}"
DURATION="${DURATION:-30}"
LOCAL_OUTPUT="${LOCAL_OUTPUT:-${HOME}/ipsec-captures}"
```

### Output Formatting
- Use section headers for multi-phase operations
- Show progress with countdown timers
- Provide analysis commands in summary
- Use colors sparingly (define as readonly constants)

## Open Source Guidelines
- Never include usernames or personal identifiers
- Use generic placeholders: `worker1.example.com`, `<your-username>`
- Keep examples reusable by anyone

## Code Review Checklist

Before committing:
- [ ] Script starts with `#!/bin/bash` and `set -euo pipefail`
- [ ] All variables are quoted
- [ ] Node names are validated before `oc debug`
- [ ] Cluster connectivity is checked
- [ ] Temporary files are cleaned up
- [ ] Error messages include troubleshooting hints
- [ ] No hardcoded credentials or usernames
- [ ] Output uses timestamp-based naming

## Anti-Patterns to Avoid

- ❌ Unquoted variables
- ❌ Missing `set -euo pipefail`
- ❌ Hardcoded node names without defaults
- ❌ Running `oc debug` without timeout
- ❌ Not cleaning up remote temp files
- ❌ Using Docker instead of Podman
- ❌ Including personal identifiers in code/docs
- ❌ Complex nested logic (violates KISS)
